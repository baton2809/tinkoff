"""
–ë—ã—Å—Ç—Ä—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –æ—à–∏–±–∫–∏ MPS memory
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
"""

import os
import sys

def apply_immediate_fixes():
    """–ü—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è MPS memory error"""
    print("üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±—ã—Å—Ç—Ä—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –¥–ª—è MPS memory error\n")
    
    # 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    print("1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...")
    os.environ['PYTORCH_ENABLE_MPS_FALLBACK'] = '1'
    os.environ['OMP_NUM_THREADS'] = '1'
    os.environ['MKL_NUM_THREADS'] = '1'
    print("‚úì –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
    
    # 2. –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
    print("\n2. –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏...")
    try:
        import torch
        import gc
        
        if torch.mps.is_available():
            torch.mps.empty_cache()
            print("‚úì MPS –∫—ç—à –æ—á–∏—â–µ–Ω")
        
        gc.collect()
        print("‚úì –°–±–æ—Ä—â–∏–∫ –º—É—Å–æ—Ä–∞ –∑–∞–ø—É—â–µ–Ω")
        
    except ImportError:
        print("‚ö† PyTorch –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É MPS")
    
    # 3. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
    print("\n3. –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:")
    print("–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –æ–±—É—á–µ–Ω–∏—è:")
    print("export PYTORCH_ENABLE_MPS_FALLBACK=1")
    print("export OMP_NUM_THREADS=1")
    print("export MKL_NUM_THREADS=1")
    
    # 4. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    print("\n4. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±—É—á–µ–Ω–∏—è:")
    print("- max_samples=200-500 (–≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞)")
    print("- batch_size=1 (–≤–º–µ—Å—Ç–æ 2)")
    print("- max_length=64-128 (–≤–º–µ—Å—Ç–æ 256)")
    print("- gradient_accumulation_steps=8-16")
    
    print("\n‚úÖ –ë—ã—Å—Ç—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!")
    print("–¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ: python train_reward_model_optimized.py")

if __name__ == "__main__":
    apply_immediate_fixes()
